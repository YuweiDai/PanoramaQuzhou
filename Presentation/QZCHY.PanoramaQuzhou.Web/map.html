<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>全景衢州111</title>
    <base href="/">
    <script type="text/javascript" src="https://appx/web-view.min.js"></script>
    <script type="text/javascript" src="js/mapbox-gl.js"></script>
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/mapbox-gl.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var baseUrl = "http://abcde.vaiwan.com/";

        function MyLocateControl() { }

        MyLocateControl.prototype.onAdd = function (map) {
            this._map = map;
            this._container = document.createElement('div');
            this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
            this._container.innerHTML = '<button class="mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate" type="button" aria-label="Geolocate" aria-pressed="false"></button>';
            return this._container;
        };

        MyLocateControl.prototype.onRemove = function () {
            this._container.parentNode.removeChild(this._container);
            this._map = undefined;
        };

        if (navigator.userAgent.toLowerCase().indexOf('dingtalk') > -1) {
            document.writeln('<script src="https://appx/web-view.min.js"' + '>' + '<' + '/' + 'script>');
        }

        //dd.alert({
        //    title: '亲',
        //    content: '您本月的账单已出',
        //    buttonText: '我知道了',
        //    success: () => {
        //        dd.alert({
        //            title: '用户点击了「我知道了」',
        //        });

        //        dd.postMessage({ name: "测试web-view" });
        //    },
        //});

       // dd.navigateTo({ url: '../home/home' });

        var markers = [];

        var map = new mapboxgl.Map({
            container: 'map',
            minZoom: 7,
            maxZoom: 19,
            style: 'http://map.zjditu.cn/vtiles/styles/tdt/streets.json',
            zoom: 12,
            center: [118.8546503613, 28.9731569040],
            renderWorldCopies: false,
            localIdeographFontFamily: "'黑体','san-serif'"
        });
        var nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'top-left');
        map.addControl(new MyLocateControl(), 'bottom-left');

        map.on('zoomend', function (data) {
            console.log(data);
        });


        $.ajax({
            type: "GET",
            url: baseUrl+"api/Panolocations/map",
            dataType: "json",
            success: function (data) {
                data.forEach(function (item) {

                    var el = document.createElement('div');
                    el.className = 'marker';
                    el.style.backgroundImage = 'url(./assets/location.png)';
                    el.style.backgroundSize = "cover";
                    el.style.width = '20px';
                    el.style.height = '20px';
                    el.style.cursor = "pointer";

                    // create the popup
                    var navBtn = document.createElement('strong');
                    navBtn.innerText = item.name + (item.defaultPanoramaSceneId > 0 ? "(点击查看)" : "(全局拍摄中...)");
                    navBtn.addEventListener('click', function () {
                        //if (dd = undefined) {
                        //    alert("no dd obejct")
                        //    return;
                        //}
                        //else {
                        //    alert("123");

                        //    dd.navigateTo({
                        //        url: '../Panorama/Panorama?sid=' + item.defaultPanoramaSceneId
                        //    })
                        //}
                    });

                    var popup = new mapboxgl.Popup({ offset: 25 }).setDOMContent(navBtn);

                    // add marker to map
                    var marker = new mapboxgl.Marker({ element: el, anchor: "bottom" })
                        .setLngLat([item.lng, item.lat]).setPopup(popup).addTo(map);

                    markers.push(marker);
                });
            },
            error: function (jqXHR) {
                console.log("Error: " + jqXHR.status);
            }
        });
 



        //dd.getLocation({
        //    success(res) {
        //        var lng = res.longitude;
        //        var lat = res.latitude;
        //        dd.alert({
        //            title: '亲1',
        //            content: '您本月的账单已出',
        //            buttonText: '我知道了',
        //            success: () => {
        //                dd.alert({
        //                    title: '用户点击了「我知道了」',
        //                });
        //            },
        //        });
        //        //alert('经度：' + lng);
        //        //alert('纬度：' + lat);
        //        ////添加定位点
        //        //var el = document.createElement('div');
        //        //el.className = 'mapboxgl-user-location-dot mapboxgl-marker mapboxgl-marker-anchor-center';
        //        //el.style.transform = "translate(-50%, -50%) translate(960px, 469px);";

        //        //// add location to map
        //        //var m = new mapboxgl.Marker({ element: el, anchor: "bottom" })
        //        //    .setLngLat([lng, lat]).addTo(app.map);
        //    },
        //    fail() {
        //        dd.alert({
        //            title: '亲2',
        //            content: '您本月的账单已出',
        //            buttonText: '我知道了',
        //            success: () => {
        //                dd.alert({
        //                    title: '用户点击了「我知道了」',
        //                });
        //            },
        //        });
        //    },
        //    complete() {
        //        dd.alert({
        //            title: '亲3',
        //            content: '您本月的账单已出',
        //            buttonText: '我知道了',
        //            success: () => {
        //                dd.alert({
        //                    title: '用户点击了「我知道了」',
        //                });
        //            },
        //        });
        //    }
        //});




       

        // 接收来自E应用的消息。
        //dd.onMessage = function (e) {
        //    console.log(e); //{'sendToWebView': '1'}
        //}

    </script>
</body>
</html>
